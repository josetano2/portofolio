---
import type { IStack } from "../../lib/models/model";

interface Props {
  stack: IStack;
}

const { stack } = Astro.props;

const hexToRgb = (hex: string) => {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result
    ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16),
      }
    : { r: 0, g: 0, b: 0 };
};

const colorLower = stack.color?.toLowerCase() || "#000000";
const isBlack = colorLower === "#000000" || colorLower === "#000";
const isWhite = colorLower === "#ffffff" || colorLower === "#fff";

const lightModeColor = stack.color || "#000000";
const darkModeColor = isBlack
  ? "#ffffff"
  : isWhite
    ? "#000000"
    : stack.color || "#000000";

const glowColorSource = isBlack
  ? "#ffffff"
  : isWhite
    ? "#000000"
    : stack.color || "#000000";
const rgb = hexToRgb(glowColorSource);
const glowColor = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
---

<div
  class="stack-card flex flex-col items-center justify-center p-4 rounded-lg transition-colors duration-300"
  data-glow-color={glowColor}
  data-light-color={lightModeColor}
  data-dark-color={darkModeColor}
>
  <div
    class="icon-glow text-5xl mb-3 transition-[filter] duration-150 ease-in-out"
  >
    <stack.icon className="stack-icon" />
  </div>
  <p
    class="stack-name text-sm font-medium text-slate-700 dark:text-slate-300 text-center"
  >
    {stack.name}
  </p>
</div>

<script>
  import gsap from "gsap";

  document.addEventListener("DOMContentLoaded", () => {
    const stackCards = document.querySelectorAll(
      ".stack-card"
    ) as NodeListOf<HTMLElement>;

    stackCards.forEach((card) => {
      const icon = card.querySelector(".icon-glow") as HTMLElement;
      const iconSvg = icon.querySelector(".stack-icon") as SVGElement;
      const glowColor = card.getAttribute("data-glow-color") || "100, 116, 139";
      const lightColor = card.getAttribute("data-light-color") || "#000000";
      const darkColor = card.getAttribute("data-dark-color") || "#000000";

      const updateIconColor = () => {
        const isDark = document.documentElement.classList.contains("dark");
        if (iconSvg) {
          iconSvg.style.color = isDark ? darkColor : lightColor;
        }
      };

      updateIconColor();
      icon.style.filter = `drop-shadow(0 0 8px rgba(${glowColor}, 0.3))`;

      const observer = new MutationObserver(updateIconColor);
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"],
      });

      card.addEventListener("mouseenter", () => {
        gsap.to(icon, {
          scale: 1.2,
          rotation: 5,
          duration: 0.6,
          ease: "elastic.out(1, 0)",
          overwrite: true,
        });

        icon.style.filter = `drop-shadow(0 0 16px rgba(${glowColor}, 0.8)) drop-shadow(0 0 24px rgba(${glowColor}, 0.5))`;
      });

      card.addEventListener("mouseleave", () => {
        gsap.to(icon, {
          scale: 1,
          rotation: 0,
          duration: 0.5,
          ease: "elastic.out(1, 0)",
          overwrite: true,
        });

        icon.style.filter = `drop-shadow(0 0 8px rgba(${glowColor}, 0.3))`;
      });
    });
  });
</script>
